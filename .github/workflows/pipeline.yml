name: Production CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ------------------------------------------------------------------
  # JOB 1: BACKEND (Java + Maven + Flyway Validation)
  # ------------------------------------------------------------------
  backend-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: socialdb
          POSTGRES_USER: social
          POSTGRES_PASSWORD: social
        ports:
          - 5432:5432
        # Health check to ensure DB is ready before test runs
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: âœ… Checkout code
      uses: actions/checkout@v4
 # ---------------- BACKEND BUILD ----------------
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Validate Flyway Migrations
      # We just compile; if entities or Flyway scripts are broken, tests will fail
      run: mvn clean verify
      working-directory: ./backend
      env:
        DB_URL: jdbc:postgresql://localhost:5432/socialdb
        DB_USER: social
        DB_PASS: social
        JWT_SECRET: "12345678901234567890123456789012" # Dummy for test

  # ------------------------------------------------------------------
  # JOB 2: FRONTEND (Node + Vite + Lint)
  # ------------------------------------------------------------------
  frontend-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: social-ui/package-lock.json

    - name: Install Dependencies
      run: npm ci
      working-directory: ./social-ui

    - name: Lint Code
      run: npm run lint
      working-directory: ./social-ui

    - name: Build Production Bundle
      run: npm run build
      working-directory: ./social-ui

  # ------------------------------------------------------------------
  # JOB 3: DOCKER BUILD (Mock Deploy)
  # ------------------------------------------------------------------
  docker-build:
    needs: [backend-test, frontend-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' # Only build images on main branch
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # In a real setup, we would login to DockerHub/GHCR here
    # - name: Login to Docker Hub
    #   uses: docker/login-action@v3
    #   with:
    #     username: ${{ secrets.DOCKERHUB_USERNAME }}
    #     password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build Backend Image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: false # Set to true after configuring registry
        tags: user/social-backend:latest

    - name: Build Frontend Image
      uses: docker/build-push-action@v5
      with:
        context: ./social-ui
        push: false # Set to true after configuring registry
        tags: user/social-frontend:latest
